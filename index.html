<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Utama BKAD Mentawai</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f9; }
        header {
            background: #0d6efd; color: white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-title { font-size: 20px; font-weight: bold; cursor: pointer; }
        .header-filters { display: flex; gap: 15px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 11px; margin-bottom: 4px; font-weight: bold; }
        .filter-group select, .filter-group input { 
            padding: 8px 12px; border-radius: 6px; border: none; font-size: 13px; outline: none;
            background: white; color: #333; min-width: 160px;
        }
        .container { width: 96%; margin: 20px auto; }
        
        /* CARD STYLE ASLI */
        .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .card { padding: 20px; border-radius: 12px; color: white; cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card h3 { margin: 0; font-size: 11px; text-transform: uppercase; opacity: 0.9; }
        .card p { margin: 10px 0 5px; font-size: 24px; font-weight: bold; }
        .card span { font-size: 10px; opacity: 0.8; }
        .blue { background: #007bff; } .green { background: #28a745; }
        .orange { background: #fd7e14; } .red { background: #dc3545; }

        .charts-grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .chart-container { position: relative; height: 320px; width: 100%; }

        /* SEARCH DROPDOWN PERBAIKAN */
        .search-container { position: relative; }
        .results { 
            position: absolute; top: 55px; right: 0; background: white; 
            border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-height: 300px; width: 350px; overflow-y: auto; display: none; z-index: 2000;
            border: 1px solid #ddd;
        }
        .results div { padding: 12px; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .results div:hover { background: #e7f1ff; color: #0d6efd; font-weight: bold; }
        .opt-all { background: #f8f9fa; font-weight: bold; color: #0d6efd !important; }

        /* TABEL SCROLL */
        .table-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .table-scroll { max-height: 400px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 10; padding: 12px 15px; border-bottom: 2px solid #dee2e6; text-align: left; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; color: #444; }
        tr:hover { background: #f1f7ff; cursor: pointer; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; }
    </style>
</head>
<body>

<header>
    <div class="header-title" onclick="location.reload()">BKAD MENTAWAI</div>
    <div class="header-filters">
        <div class="filter-group">
            <label>Tahun Anggaran</label>
            <select id="selTahun">
                <option>2025</option><option>2026</option><option>2027</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Sumber Dana</label>
            <select id="selDana">
                <option>SEMUA SUMBER DANA</option>
                <option>PAD</option><option>DAU</option><option>DAK</option>
            </select>
        </div>
        <div class="filter-group search-container">
            <label>Unit Kerja (OPD)</label>
            <input type="text" id="opdInput" placeholder="-- Pilih OPD --" readonly>
            <div id="opdResults" class="results"></div>
        </div>
    </div>
</header>

<div class="container">
    <div class="cards">
        <div class="card blue" onclick="location.href='pendapatan.html'">
            <h3>PAGU PENDAPATAN</h3><p id="txtPagu">Rp 0</p><span>Detail Pendapatan</span>
        </div>
        <div class="card green" onclick="location.href='belanja.html'">
            <h3>REALISASI BELANJA</h3><p id="txtRealisasi">Rp 0</p><span>Detail Belanja</span>
        </div>
        <div class="card orange" onclick="location.href='capaian.html'">
            <h3>PERSENTASE CAPAIAN</h3><p id="txtPersen">0%</p><span>Evaluasi Kinerja</span>
        </div>
        <div class="card red" onclick="location.href='sisa-anggaran.html'">
            <h3>SISA ANGGARAN</h3><p id="txtSisa">Rp 0</p><span>Kontrol Pagu</span>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h4 style="margin:0 0 15px; color:#555;">Komparasi Realisasi (Miliar)</h4>
            <div class="chart-container"><canvas id="canvasBar"></canvas></div>
        </div>
        <div class="chart-card">
            <h4 style="margin:0 0 15px; color:#555;">Rasio Penyerapan</h4>
            <div class="chart-container"><canvas id="canvasPie"></canvas></div>
        </div>
    </div>

    <div class="table-card">
        <h4 style="margin:0; color:#333;">Ringkasan Realisasi Per Unit Kerja (OPD)</h4>
        <div class="table-scroll">
            <table>
                <thead>
                    <tr>
                        <th>No</th><th>Nama Unit Kerja (OPD)</th><th>Pagu (M)</th><th>Realisasi (M)</th><th>Sisa (M)</th><th>%</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="data.js"></script>

<script>
let chartBar, chartPie;

function initCharts() {
    chartBar = new Chart(document.getElementById('canvasBar'), {
        type: 'bar',
        data: {
            labels: ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'],
            datasets: [
                { label: 'Pendapatan', backgroundColor: '#0d6efd', data: [] },
                { label: 'Belanja', backgroundColor: '#198754', data: [] }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    chartPie = new Chart(document.getElementById('canvasPie'), {
        type: 'doughnut',
        data: {
            labels: ['Realisasi', 'Sisa'],
            datasets: [{ backgroundColor: ['#28a745', '#dee2e6'], data: [0, 100] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function renderTable() {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    if (typeof belanjaData === 'undefined') return;
    belanjaData.forEach((item, index) => {
        const pagu = item.anggaran || 0;
        const real = item.realisasi || 0;
        const sisa = pagu - real;
        const persen = ((real / (pagu || 1)) * 100).toFixed(1);
        tbody.innerHTML += `<tr onclick="updateDashboard(${index})">
            <td>${index === 0 ? '★' : index}</td>
            <td style="font-weight:${index === 0 ? 'bold' : '500'}">${item.nama}</td>
            <td>${(pagu / 1e9).toFixed(2)}</td><td>${(real / 1e9).toFixed(2)}</td>
            <td>${(sisa / 1e9).toFixed(2)}</td>
            <td><span class="badge" style="background:${persen > 70 ? '#28a745':'#fd7e14'}">${persen}%</span></td>
        </tr>`;
    });
}

function updateDashboard(idx) {
    if (typeof pendapatanData === 'undefined' || !pendapatanData[idx]) return;
    const dP = pendapatanData[idx];
    const dB = belanjaData[idx];
    document.getElementById("txtPagu").innerText = "Rp " + ((dP.target || 0) / 1e9).toFixed(2) + " M";
    document.getElementById("txtRealisasi").innerText = "Rp " + ((dB.realisasi || 0) / 1e9).toFixed(2) + " M";
    document.getElementById("txtPersen").innerText = (((dB.realisasi || 0) / (dB.anggaran || 1)) * 100).toFixed(1) + "%";
    document.getElementById("txtSisa").innerText = "Rp " + (((dB.anggaran || 0) - (dB.realisasi || 0)) / 1e9).toFixed(2) + " M";
    document.getElementById("opdInput").value = dP.nama;
    chartBar.data.datasets[0].data = dP.bulanan ? dP.bulanan.map(v => v / 1e9) : [];
    chartBar.data.datasets[1].data = dB.bulananBelanja ? dB.bulananBelanja.map(v => v / 1e9) : [];
    chartBar.update();
    chartPie.data.datasets[0].data = [dB.realisasi || 0, (dB.anggaran || 0) - (dB.realisasi || 0)];
    chartPie.update();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

const inp = document.getElementById("opdInput");
const res = document.getElementById("opdResults");

inp.onclick = (e) => {
    res.innerHTML = "";
    if (typeof opdList !== 'undefined') {
        opdList.forEach((nama, i) => {
            const div = document.createElement("div");
            div.innerText = nama;
            if (nama === "SEMUA OPD") div.className = "opt-all";
            div.onclick = () => { updateDashboard(i); res.style.display = "none"; };
            res.appendChild(div);
        });
        res.style.display = "block";
    }
    e.stopPropagation();
};

window.onload = () => {
    initCharts();
    setTimeout(() => {
        if (typeof opdList !== 'undefined') {
            renderTable();
            updateDashboard(0);
        }
    }, 250);
};
document.addEventListener("click", () => res.style.display = "none");
</script>
</body>
</html>