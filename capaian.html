<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capaian Realisasi Per OPD - Mentawai</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6f9; color: #333; }
        header {
            background: linear-gradient(to right, #fd7e14, #e67e22);
            color: white; padding: 20px; text-align: center;
            font-size: 22px; font-weight: bold;
        }
        .container { width: 94%; margin: auto; margin-top: 20px; padding-bottom: 50px; }
        .box {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); margin-bottom: 20px;
        }

        .filter-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .filter-item { flex: 1; min-width: 200px; position: relative; }

        select, input {
            padding: 12px; border-radius: 10px; border: 1px solid #ccc;
            font-size: 15px; margin-top: 8px; width: 100%; box-sizing: border-box;
            cursor: pointer; outline: none; background: white;
        }

        /* CUSTOM DROPDOWN OPD */
        .custom-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ccc; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 250px; overflow-y: auto;
            display: none; z-index: 1000; margin-top: 5px;
        }
        .custom-dropdown div { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .custom-dropdown div:hover { background: #fff5eb; color: #fd7e14; font-weight: bold; }

        /* CHARTS LAYOUT */
        .chart-box { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .chart-container { position: relative; height: 320px; width: 100%; }

        /* TABLE STYLING */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        table th { background: #f8f9fa; color: #666; text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; }
        table td { padding: 12px; border-bottom: 1px solid #eee; }
        .badge-orange { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #fff5eb; color: #fd7e14; }

        .back {
            display: inline-block; margin-top: 15px; padding: 10px 18px;
            background: #fd7e14; color: white; text-decoration: none;
            border-radius: 10px; font-weight: bold;
        }

        @media (max-width: 768px) { .chart-box { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header>
        Dashboard Analisis Capaian Realisasi Per OPD <br>
        Kabupaten Kepulauan Mentawai
    </header>

    <div class="container">
        <div class="box">
            <div class="filter-container">
                <div class="filter-item">
                    <label><b>Tahun Anggaran:</b></label>
                    <select id="tahunFilter" onchange="refreshCurrentData()">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>

                <div class="filter-item" id="opdWrapper">
                    <label><b>Pilih Unit Kerja (OPD):</b></label>
                    <input type="text" id="opdInput" placeholder="Klik untuk memilih OPD..." readonly>
                    <div id="opdDropdown" class="custom-dropdown"></div>
                </div>
            </div>
        </div>

        <div class="box chart-box">
            <div>
                <h2 id="barTitle" style="font-size: 18px; color: #fd7e14;">Perbandingan Bulanan</h2>
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>
            <div>
                <h2 style="font-size: 18px; color: #fd7e14;">Rasio Keuangan</h2>
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>
        </div>

        <div class="box">
            <h2 style="font-size: 18px; color: #fd7e14; margin-bottom: 15px;">Evaluasi Kinerja Capaian Anggaran</h2>
            <table>
                <thead>
                    <tr>
                        <th>Indikator Kinerja</th>
                        <th>Target/Pagu</th>
                        <th>Realisasi</th>
                        <th>Sisa (Deviasi)</th>
                        <th>Persentase</th>
                    </tr>
                </thead>
                <tbody id="rincianBody"></tbody>
            </table>
        </div>

        <a href="index.html" class="back">⬅ Kembali ke Dashboard Utama</a>
    </div>

    <script src="data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let barChart, pieChart;
        let currentIdx = 0; // Untuk menyimpan index OPD yang sedang dipilih

        // 1. Inisialisasi Dropdown
        function initOpdList() {
            const dropdown = document.getElementById("opdDropdown");
            dropdown.innerHTML = "";
            opdList.forEach((nama, i) => {
                const item = document.createElement("div");
                item.innerText = nama;
                item.onclick = () => {
                    selectOPD(i, nama);
                };
                dropdown.appendChild(item);
            });
        }

        function selectOPD(idx, nama) {
            currentIdx = idx;
            document.getElementById("opdInput").value = nama;
            document.getElementById("opdDropdown").style.display = "none";
            updateChart(idx);
        }

        function refreshCurrentData() {
            updateChart(currentIdx);
        }

        function formatRupiah(angka) {
            return "Rp " + (angka / 1000000000).toFixed(2) + " M";
        }

        // 2. Logika Update Data (Penyebab tidak respon biasanya di sini)
        function updateChart(idx) {
            // Pastikan data dipanggil dari variabel yang ada di data.js
            const dataP = pendapatanData[idx];
            const dataB = belanjaData[idx];
            const tahun = document.getElementById("tahunFilter").value;

            document.getElementById("barTitle").innerText = `Komparasi Realisasi: ${dataP.nama} (${tahun})`;

            // Update Bar Chart
            barChart.data.datasets[0].data = dataP.bulanan.map(v => v / 1000000000);
            barChart.data.datasets[1].data = dataB.bulananBelanja.map(v => v / 1000000000);
            barChart.update();

            // Update Pie Chart
            pieChart.data.datasets[0].data = [dataP.realisasi, dataB.realisasi];
            pieChart.update();

            // Update Tabel
            const rincianBody = document.getElementById("rincianBody");
            const persenP = ((dataP.realisasi / dataP.target) * 100).toFixed(1);
            const persenB = ((dataB.realisasi / dataB.anggaran) * 100).toFixed(1);
            
            rincianBody.innerHTML = `
                <tr>
                    <td><b>Sektor Pendapatan</b></td>
                    <td>${formatRupiah(dataP.target)}</td>
                    <td>${formatRupiah(dataP.realisasi)}</td>
                    <td>${formatRupiah(dataP.target - dataP.realisasi)}</td>
                    <td><span class="badge-orange">${persenP}%</span></td>
                </tr>
                <tr>
                    <td><b>Sektor Belanja</b></td>
                    <td>${formatRupiah(dataB.anggaran)}</td>
                    <td>${formatRupiah(dataB.realisasi)}</td>
                    <td>${formatRupiah(dataB.anggaran - dataB.realisasi)}</td>
                    <td><span class="badge-orange">${persenB}%</span></td>
                </tr>
                <tr style="background:#fff5eb; font-weight:bold;">
                    <td>Surplus / (Defisit) Kas</td>
                    <td>-</td>
                    <td>${formatRupiah(dataP.realisasi - dataB.realisasi)}</td>
                    <td>-</td>
                    <td>${(dataP.realisasi > dataB.realisasi ? 'Surplus' : 'Defisit')}</td>
                </tr>
            `;
        }

        // 3. Setup Grafik Saat Awal
        function setupCharts() {
            const barCtx = document.getElementById('barChart').getContext('2d');
            const pieCtx = document.getElementById('pieChart').getContext('2d');

            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"],
                    datasets: [
                        { label: "Pendapatan (M)", backgroundColor: "#0d6efd", data: [] },
                        { label: "Belanja (M)", backgroundColor: "#198754", data: [] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ["Total Pendapatan", "Total Belanja"],
                    datasets: [{ backgroundColor: ["#0d6efd", "#198754"], data: [0, 0] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 4. Event Listeners
        document.getElementById("opdInput").onclick = (e) => {
            const dd = document.getElementById("opdDropdown");
            dd.style.display = (dd.style.display === "block") ? "none" : "block";
            e.stopPropagation();
        };

        document.onclick = (e) => {
            if (!document.getElementById("opdWrapper").contains(e.target)) {
                document.getElementById("opdDropdown").style.display = "none";
            }
        };

        window.onload = () => {
            setupCharts();
            initOpdList();
            // Jalankan data pertama kali
            selectOPD(0, opdList[0]);
        };
    </script>
</body>
</html>